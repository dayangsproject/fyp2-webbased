<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-3">
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search...">
        <table class="table table-dark">
            <thead>
                <th>No</th>
                <th>Matric No</th>
                <th>Name</th>
                <th>Intake</th>
                <th>Mode</th>
                <th>Status</th>
            </thead>
            <tbody id="tbody1"></tbody>
        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Edit Student Details</h5>
                </div>
                <div class="modal-body">
                    <!-- Input fields for editing student details will go here -->
                    <label for="matricNo">Matric No:</label>
                    <input type="text" id="matricNo" class="form-control mb-2">

                    <label for="name">Name:</label>
                    <input type="text" id="name" class="form-control mb-2">

                    <label for="intake">Intake:</label>
                    <input type="text" id="intake" class="form-control mb-2">

                    <label for="phoneNumber">Phone Number:</label>
                    <input type="text" id="phoneNumber" class="form-control mb-2">

                    <label>Mode</label>
                    <select id="mode" class="form-control">
                        <option value=""> </option>
                        <option value="febFull">February Full Time</option>
                        <option value="juneFull">June Full Time</option>
                        <option value="octFull">October Full Time</option>
                        <option value="febPart">February Part Time</option>
                        <option value="junePart">June Part Time</option>
                        <option value="octPart">October Part Time</option>
                    </select>

                    <label>Status</label>
                    <select id="status" class="form-control">
                        <option value=""> </option>
                        <option value="Active">Active</option>
                        <option value="Graduate">Graduate</option>
                        <option value="On hiatus">On hiatus</option>
                        <option value="Withdrawn">Withdrawn</option>
                        <option value="Failed and quit">Failed and quit</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button id="saveChangesBtn" type="button" class="btn btn-primary">Save changes</button>
                    <button id="closeModalBtn" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, get, set, child, update } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBYET4H_QA7j0QggLxjh-KQcX_O0h_YAao",
            authDomain: "test-99503.firebaseapp.com",
            databaseURL: "https://test-99503-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-99503",
            storageBucket: "test-99503.appspot.com",
            messagingSenderId: "1017306171186",
            appId: "1:1017306171186:web:851d2a7cde6f1a26b8792b",
            databaseURL: "https://test-99503-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    
        // Get a reference to the Firebase database
        const db = getDatabase();
    
        // Function to add buttons to each row of the table
        function addButtonsToTable(matricNo, studentName, admission, mode, status, phoneNumber) { // Add phoneNumber parameter
            
            // Create the button element
            const viewButton = document.createElement("button");
            viewButton.textContent = "View/Edit";
            viewButton.classList.add("btn", "btn-primary");
            // Add an event listener to open the modal and populate its input fields
            viewButton.addEventListener("click", function() {
                // Populate the modal input fields with student details
                document.getElementById("matricNo").value = matricNo;
                document.getElementById("name").value = studentName;
                document.getElementById("intake").value = admission;
                document.getElementById("phoneNumber").value = phoneNumber; 
                document.getElementById("mode").value = mode;
                document.getElementById("status").value = status;
                // Show the modal
                showModal();
            });

            // Create a new cell in the row and append the button
            const td = document.createElement("td");
            td.appendChild(viewButton);

            return td;
        }

        // Function to add a row to the table
        function addRowToTable(studentNo, matricNo, studentName, admission, mode, status, phoneNumber) { // Add phoneNumber parameter
            const tbody = document.getElementById('tbody1');
            const tr = document.createElement("tr");

            // Add cells to the row
            const cells = [
                studentNo,
                matricNo,
                studentName,
                admission,
                mode,
                status
            ];

            // Append cells to the row
            cells.forEach(cell => {
                const td = document.createElement("td");
                td.textContent = cell;
                tr.appendChild(td);
            });

            // Create and append the button cell
            const buttonTd = document.createElement("td");
            buttonTd.appendChild(addButtonsToTable(matricNo, studentName, admission, mode, status, phoneNumber)); // Pass phoneNumber
            tr.appendChild(buttonTd);

            // Append the row to the table body
            tbody.appendChild(tr);
        }
    
        function getAllDataOnce() {
            const dbRef = ref(db);

            get(child(dbRef, "StudentInfo")).then((snapshot) => {
                const students = [];
                snapshot.forEach((childSnapshot) => {
                    const matricNo = childSnapshot.key; // Get the matric number from the key
                    const studentData = childSnapshot.val(); // Retrieve other data
                    const { studentName, admission, mode, status, phoneNumber } = studentData; 
                    students.push({ matricNo, studentName, admission, mode, status, phoneNumber }); 
                });

                // Add each student's data to the table
                students.forEach((student, index) => {
                    addRowToTable(index + 1, student.matricNo, student.studentName, student.admission, student.mode, student.status, student.phoneNumber); 
                });
            });
        }

        // Function to show the modal
        function showModal() {
            const modal = document.getElementById('exampleModalCenter');
            modal.classList.add('show');
            modal.style.display = 'block';
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
        }

        // Event listener for the "Close" button
        document.getElementById("closeModalBtn").addEventListener("click", function() {
            closeModal();
        });

        // Event listener for the "Save changes" button
        document.getElementById("saveChangesBtn").addEventListener("click", function() {
            saveChanges();
        });

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('exampleModalCenter');
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.setAttribute('aria-modal', 'false');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        // Function to save changes to the database
        function saveChanges() {
            // Retrieve updated student details from the modal input fields
            const matricNo = document.getElementById("matricNo").value;
            const newName = document.getElementById("name").value;
            const newIntake = document.getElementById("intake").value;
            const newPhoneNumber = document.getElementById("phoneNumber").value; 
            const newMode = document.getElementById("mode").value;
            const newStatus = document.getElementById("status").value;

            // Reference to the student in the database
            const studentRef = ref(db, `StudentInfo/${matricNo}`);

            // Update student details in the database
            update(studentRef, {
                studentName: newName,
                admission: newIntake,
                phoneNumber: newPhoneNumber, 
                mode: newMode,
                status: newStatus
            })
            .then(() => {
                // Close the modal after updating
                closeModal();
                // Reload the page to see the changes in the table
                location.reload();
            })
            .catch((error) => {
                console.error("Error updating student details: ", error);
            });
        }

        // Function to handle search
        function handleSearch() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tbody1 tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let found = false;

                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchQuery)) {
                        found = true;
                    }
                });

                if (found) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Attach event listener to search input
        document.getElementById('searchInput').addEventListener('input', handleSearch);

        // Call the function to fill the table when the window loads
        window.onload = getAllDataOnce;
    </script>
    
</body>
</html>
