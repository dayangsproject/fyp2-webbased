<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/styles-2.css" />
</head>
<body>
    <!-- Main content -->
    <div id="mainContent">
        <label>Name: </label>
        <span id="displayName"></span>
        <br><br>

        <label>Email: </label>
        <span id="displayEmail"></span>
        <br><br>

        <label>Matric number</label>
        <span id="matricNoInput"></span>
        <br><br>

        <label>Mode: </label>
        <span id="modeInput"></span>
        <br><br>

        <button id="homeButton">Home</button>
    </div>

    <script type="module" src="js/sidebar.js"></script>
    <script type="module">
        // Import firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import{getDatabase, ref, get} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBYET4H_QA7j0QggLxjh-KQcX_O0h_YAao",
          authDomain: "test-99503.firebaseapp.com",
          databaseURL: "https://test-99503-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "test-99503",
          storageBucket: "test-99503.appspot.com",
          messagingSenderId: "1017306171186",
          appId: "1:1017306171186:web:851d2a7cde6f1a26b8792b",
          databaseURL: "https://test-99503-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Get references to Firebase database
        const db = getDatabase();

        let matricNoInput = document.getElementById('matricNoInput');
        let modeInput = document.getElementById('modeInput');

        // Automatically retrieve user's name and email when the page loads
        window.addEventListener('load', () => {
            const userInfo = JSON.parse(sessionStorage.getItem("user-info"));
            if (userInfo) {
                document.getElementById('displayName').textContent = userInfo.name;
                document.getElementById('displayEmail').textContent = userInfo.email;
            }       

            RetPage();
        });

        // Function to retrieve data based on user's email
        function RetPage() {
            // Retrieve user credentials from session storage
            const userCreds = JSON.parse(sessionStorage.getItem("user-creds"));

            // Check if user credentials are available
            if (userCreds) {
                const userEmail = userCreds.email;

                // Reference to the StudentInfo node in the database
                const studentInfoRef = ref(db, 'StudentInfo');

                // Get all student nodes from the database
                get(studentInfoRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        // Iterate over each child node
                        snapshot.forEach((childSnapshot) => {
                            // Retrieve the student data
                            const studentData = childSnapshot.val();
                            // Check if the email matches
                            if (studentData.email === userEmail) {
                                // Email matches, retrieve matric number
                                const matricNo = childSnapshot.key;
                                // Set the input field values or do whatever you need to do with the data
                                document.getElementById('matricNoInput').textContent = matricNo;
                                document.getElementById('modeInput').textContent = studentData.mode;
                                // Exit the loop since we found the matching email
                                return;
                            }
                        });
                    } else {
                        // No data found in the StudentInfo node
                        alert('No data found in the database');
                    }
                }).catch((error) => {
                    // Error handling
                    alert('Error retrieving data: ' + error);
                    console.error(error);
                });
            } else {
                // Handle the case where user credentials are not available
                alert('User credentials not available');
            }
        }

        // Function to navigate to home page
        function goToHome() {
            window.location.href = 'home-student.html';
        }

        // Event listener for the Home button
        const homeButton = document.getElementById('homeButton');
        homeButton.addEventListener('click', goToHome);

    </script>
</body>
</html>
